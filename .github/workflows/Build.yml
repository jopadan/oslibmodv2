name: Build
on:
  pull_request:
  push:
    branches:
      - '**'
    tags-ignore:
      - '**'

jobs:
  build:
    runs-on: ${{ matrix.os[0] }}
    strategy:
      matrix:
        os: [
          [macos-13, x86_64, bash],
          [ubuntu-22.04, x86_64, bash]
        ]
      fail-fast: false
    defaults:
      run:
        shell: ${{ matrix.os[2] }} {0}
    steps:
      - uses: actions/checkout@v4
      - &setup_pspdev
        name: Setup PSPDEV Environment
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            URL="https://github.com/pspdev/pspdev/releases/download/v20240609/pspdev-ubuntu-latest-x86_64.tar.gz"
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            URL="https://github.com/pspdev/pspdev/releases/download/v20240609/pspdev-macos-13-x86_64.tar.gz"
          fi
          FILE=$(basename $URL)
          wget $URL
          tar -xzf $FILE
          echo "PSPDEV=$PWD/pspdev" >> $GITHUB_ENV
          echo "$PWD/pspdev/bin" >> $GITHUB_PATH
          if command -v brew >/dev/null 2>&1; then
            echo "$(brew --prefix gnu-sed)/libexec/gnubin" >> $GITHUB_PATH
            echo "$(brew --prefix libtool)/libexec/gnubin" >> $GITHUB_PATH
            echo "PKG_CONFIG_PATH=$(brew --prefix libarchive)/lib/pkgconfig:$(brew --prefix openssl)/lib/pkgconfig" >> $GITHUB_ENV
          fi
      - name: Runs build in shell
        run: |
          make
          make install

      - name: Build all samples
        run: |
          for d in samples/*/ ; do
            if [ -f "$d/makefile" ] || [ -f "$d/Makefile" ]; then
              echo "Building $d"
              make -C "$d"
            fi
          done